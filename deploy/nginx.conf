worker_processes auto;
events { worker_connections 1024; }

http {
  # ---- Caches ----
  proxy_cache_path /var/cache/nginx/ssr_html
      levels=1:2 keys_zone=SSR_HTML:20m max_size=1g inactive=60s use_temp_path=off;

  proxy_cache_path /var/cache/nginx/static
      levels=1:2 keys_zone=STATIC:20m  max_size=2g inactive=14d use_temp_path=off;

  # Bypass HTML cache when user looks logged in (adjust cookie names)
  map $http_cookie $bypass_html_cache {
    default 0;
    ~*(session|jwt|auth)= 1;
  }

  # ---- Upstreams (your Node processes) ----
  upstream angular_ssr {
    server 127.0.0.1:4200;  # Angular Universal server.mjs
    keepalive 64;
  }

  upstream socketio {
    server 127.0.0.1:4000;  # your realtime-server
    keepalive 64;
  }

  # ---- Gzip (optional, simple) ----
  gzip on;
  gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;
  gzip_min_length 1024;

  server {
    listen 80;
    server_name _;  # change to your domain for prod

    # -------- WebSocket proxy for Socket.IO --------
    location /socket.io/ {
      proxy_pass http://socketio;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_read_timeout 600s;
      proxy_send_timeout 600s;
      # No caching for WS
    }

    # -------- Long-cache for static assets --------
    # If Angular SSR serves static files via the same server
    location ~* \.(?:js|mjs|css|map|woff2?|ttf|eot|png|jpg|jpeg|gif|svg)$ {
      proxy_pass http://angular_ssr;
      proxy_http_version 1.1;

      proxy_cache STATIC;
      proxy_cache_key $scheme$proxy_host$request_uri;
      proxy_ignore_headers Set-Cookie;
      add_header Cache-Control "public, max-age=31536000, immutable";
      expires 1y;
    }

    # -------- SSR HTML with micro-cache --------
    location / {
      proxy_pass http://angular_ssr;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $remote_addr;

      proxy_cache        SSR_HTML;
      proxy_cache_valid  200 2s;           # tiny TTL to absorb bursts
      proxy_cache_bypass $bypass_html_cache;
      proxy_no_cache     $bypass_html_cache;

      add_header X-Cache-Status $upstream_cache_status;
      add_header Cache-Control "no-store"; # donâ€™t let browsers cache personalized pages
    }
  }
}
